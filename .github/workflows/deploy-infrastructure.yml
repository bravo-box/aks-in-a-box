name: Deploy AKS Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
      cloud_type:
        description: 'Azure Cloud Type'
        required: true
        type: choice
        options:
          - AzureCloud
          - AzureUSGovernment
        default: AzureCloud

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load environment configuration
        id: load-env
        run: |
          ENV_FILE="environments/.env.${{ github.event.inputs.environment }}"
          
          if [ ! -f "$ENV_FILE" ]; then
            echo "Error: Environment file $ENV_FILE not found"
            exit 1
          fi
          
          echo "Loading configuration from $ENV_FILE"
          
          # Read the env file and export variables
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip comments and empty lines
            if [[ ! "$line" =~ ^[[:space:]]*# ]] && [[ -n "$line" ]]; then
              # Remove leading/trailing whitespace
              line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
              
              # Export variable if it's not empty
              if [[ -n "$line" ]]; then
                export "$line"
                # Also set as output for later steps
                var_name=$(echo "$line" | cut -d'=' -f1)
                var_value=$(echo "$line" | cut -d'=' -f2-)
                echo "$var_name=$var_value" >> $GITHUB_OUTPUT
              fi
            fi
          done < "$ENV_FILE"
          
          # Override CLOUD_ENV with workflow input
          export CLOUD_ENV="${{ github.event.inputs.cloud_type }}"
          echo "CLOUD_ENV=${{ github.event.inputs.cloud_type }}" >> $GITHUB_OUTPUT
          
          echo "Configuration loaded successfully"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets[format('AZURE_CREDENTIALS_{0}', upper(github.event.inputs.environment))] }}
          enable-AzPSSession: false
          environment: ${{ github.event.inputs.cloud_type }}

      - name: Set Azure Cloud
        run: |
          echo "Setting Azure cloud to: ${{ github.event.inputs.cloud_type }}"
          az cloud set --name "${{ github.event.inputs.cloud_type }}"
          az account show

      - name: Prepare environment file for deployment
        run: |
          # Create a temporary env file for the deployment script
          ENV_FILE="./.temp.infra.env"
          
          # Copy the environment configuration
          cp "environments/.env.${{ github.event.inputs.environment }}" "$ENV_FILE"
          
          # Override CLOUD_ENV in the env file
          sed -i "s/^CLOUD_ENV=.*/CLOUD_ENV=${{ github.event.inputs.cloud_type }}/" "$ENV_FILE"
          
          echo "Environment file prepared for deployment"

      - name: Validate prerequisites
        run: |
          echo "Validating Azure subscription and permissions..."
          az account show
          
          # Check if logged in
          if ! az account show &>/dev/null; then
            echo "Error: Not logged in to Azure"
            exit 1
          fi
          
          echo "Azure subscription validation successful"

      - name: Deploy infrastructure
        env:
          ADMIN_PASSWORD: ${{ secrets.JUMPBOX_ADMIN_PASSWORD }}
          AUTO_APPROVE: 'true'
        run: |
          # Make the deployment script executable
          chmod +x ./scripts/deploy_infra.sh
          
          # The script will read from ./.temp.infra.env which we prepared
          # Export the admin password and auto-approve for non-interactive mode
          export ADMIN_PASSWORD="${{ secrets.JUMPBOX_ADMIN_PASSWORD }}"
          export AUTO_APPROVE="true"
          
          # Run the deployment script
          # The script sources the .temp.infra.env file we created
          ./scripts/deploy_infra.sh

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cloud Type**: ${{ github.event.inputs.cloud_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "infra.parameters.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Generated Parameters" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat infra.parameters.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts-${{ github.event.inputs.environment }}
          path: |
            infra.parameters.json
            .temp.infra.env
          retention-days: 30
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        run: |
          # Remove sensitive files
          rm -f .temp.infra.env
          echo "Cleanup completed"
